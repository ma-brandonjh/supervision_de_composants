<!doctype html>
<html lang="fr">
    <head>
        <meta charset="UTF-8">
        <title>Mesure</title>
        <style>
            *{
    padding:0px;
    margin:0px;
}

header{
    background-color: aquamarine;
    padding:2%;
}

header ul{
    display:flex;
    align-content:center;
}

header ul li{
    margin:5px;
}

ul{
    display:flex;
    text-decoration: none;
    text-decoration-style: none;
}

li{
    text-decoration: none;
    text-decoration-style: none;   
}


main{
    display:flex;
    align-items: flex-start;
    margin:2%;
}

.divb{
    border-radius:8px;
    border:2px solid;
    padding:2%;
    margin:2%;
    width: 150px;
    background-color: rgb(207, 207, 207);
}

.diva{
    display:flex;
    flex-direction: column;
    align-items:center;
    border-radius:8px;
    border:2px solid;
    padding:2%;
    margin:1%;
    width:40%;
    background-color: rgba(139, 255, 255, 0.377);
}

h1{
    display:flex;
    justify-content:center;
}

.diva table{
    border-radius: 8px;
    padding:1%;
}

h3{
    text-decoration: underline;
    margin-top:8px;
}

h4{
    margin-bottom:8px;
}

.divc{
    background-color: white;
}

header ul li button{
    width:200px;
}

header ul {
    display:flex;
    justify-content: center;
}

ul{
    list-style-type:none;
}

header ul li button a{
    text-decoration: none;
    color:black;
}


button{
    border-radius: 8px;
    padding-top:5px;
    padding-bottom:5px;
    padding-left:10px;
    padding-right:10px;
    border-color:black;
    margin:2%;
}

table{
    border:solid;
}

th{
    border:solid;
    padding:1%;
}

footer{
    display:flex;
    justify-content:center;
    align-content:center;
}

button:hover{
    background-color: rgb(151, 248, 248);
    border-color:red;
}

.center{
    display:flex;
    justify-content:center;
}

        </style>
        <link rel="stylesheet" href="./css/index.css">
    </head>



    <body>
        <header>
            <h1>Section --- Température et humidité</h1>
            <ul>
                <li><a href="/"><button>Accueil</button></a></li>
                <li><a href="/mesure"><button>Température et humidité</button></a></li>
                <li><a href="/led-state"><button>États des LEDs</button></a></li>
                <li><a href="/led-cmd"><button>Contrôle des LEDs</button></a></li>
            </ul>
        </header>

<hr>

        <main class="center"><div class="diva">
            <h2>Journal des dernières mesures</h2><br>
                <div class="divc" id="table-container"></div>
                            <ul>
                <li><button onclick="rafraichirTable()">Rafraichir</button></li>
            </ul>
            </div>
            </main>


<script>
function randomData() {
  const n = Math.floor(Math.random() * 16); // 0 à 15
  const maintenant = Date.now();
  const unJour = 24 * 60 * 60 * 1000;
  const arr = [];

  for (let i = 0; i < n; i++) {
    const offset = Math.floor(Math.random() * 365) * unJour;
    const d = new Date(maintenant - offset);
    const fmt = d.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short', year: 'numeric' }) +
                ' ' +
                d.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }).replace(':', 'h');

    arr.push({
      date: fmt,
      température: (Math.random() * 55 - 20).toFixed(1), // -20 à +35
      humidité: Math.floor(Math.random() * 101)          // 0 à 100 %
    });
  }

  return arr;
}

function parseDate(str) {
  return new Date(str.replace('h', ':'));
}

function generateTable(data) {
  const container = document.getElementById("table-container");
  container.innerHTML = '';

  if (!data.length) {
    container.textContent = "Aucune donnée.";
    return;
  }

  const table = document.createElement("table");
  const thead = document.createElement("thead");
  const tbody = document.createElement("tbody");

  const headers = ['Date', 'Température (°C)', 'Humidité (%)'];
  const headerRow = document.createElement("tr");
  headers.forEach(label => {
    const th = document.createElement("th");
    th.textContent = label;
    headerRow.appendChild(th);
  });
  thead.appendChild(headerRow);

  data.slice(0, 10).forEach(item => {
    const tr = document.createElement("tr");

    const tdDate = document.createElement("td");
    tdDate.textContent = item.date;
    tr.appendChild(tdDate);

    const tdTemp = document.createElement("td");
    tdTemp.textContent = `${item.température} °C`;
    tr.appendChild(tdTemp);

    const tdHum = document.createElement("td");
    tdHum.textContent = `${item.humidité} %`;
    tr.appendChild(tdHum);

    tbody.appendChild(tr);
  });

  table.appendChild(thead);
  table.appendChild(tbody);
  container.appendChild(table);
}

function rafraichirTable() {
  fetch('/mesures')
    .then(res => {
      if (!res.ok) throw new Error(`Erreur HTTP ${res.status}`);
      return res.json();
    })
    .then(data => {
      // On suppose que les données ont la même structure que randomData()
      if (!Array.isArray(data)) throw new Error("Données invalides");
      data.sort((a, b) => parseDate(b.date) - parseDate(a.date));
      generateTable(data);
    })
    .catch(err => {
      console.warn("Fetch échoué, utilisation des données aléatoires :", err);
      const data = randomData().sort((a, b) => parseDate(b.date) - parseDate(a.date));
      generateTable(data);
    });
}

// Affiche au chargement
rafraichirTable();
</script>

    </body>
</html>